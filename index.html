<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frames by Arju</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade { animation: fadeIn 2s ease-in-out; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-black text-white font-sans">

    <div id="loader" class="fixed inset-0 flex items-center justify-center bg-black z-50">
        <h1 class="text-3xl md:text-5xl font-bold animate-fade text-orange-500 tracking-tighter uppercase">Frames by Arju</h1>
    </div>

    <div id="app" class="hidden p-4">
        <header class="text-center mb-8">
            <h2 class="text-xl font-light tracking-widest uppercase">Gallery</h2>
            
            <div id="admin-panel" class="hidden mt-5 p-4 border border-dashed border-gray-600 rounded">
                <p class="text-[10px] text-gray-400 mb-2 font-bold uppercase">Admin Access</p>
                <div id="status" class="text-orange-500 text-[10px] mb-2 font-bold italic"></div>
                <input type="file" id="file-input" multiple accept="image/*" class="hidden">
                <button onclick="document.getElementById('file-input').click()" class="bg-white text-black px-4 py-2 rounded text-[10px] font-bold">ADD PHOTOS</button>
                <button onclick="toggleQR()" class="bg-orange-600 px-4 py-2 rounded text-[10px] font-bold ml-1">GENERATE QR</button>
            </div>
        </header>

        <div id="qr-box" class="hidden bg-white p-4 rounded-lg mx-auto max-w-[200px] text-center mb-8">
            <div id="qrcode" class="flex justify-center"></div>
            <p class="text-black text-[10px] mt-2 font-bold uppercase">Scan to view photos</p>
        </div>

        <div class="flex justify-between items-center mb-4">
            <span id="photo-count" class="text-[10px] text-gray-400 uppercase tracking-widest">Loading Gallery...</span>
            <button onclick="downloadAllZip()" class="bg-green-600 text-[10px] px-3 py-1 rounded-full font-bold uppercase">Download All</button>
        </div>

        <div id="gallery" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2"></div>
    </div>

    <script>
        // --- നിങ്ങളുടെ കോൺഫിഗറേഷൻ ---
        const CLOUD_NAME = "dlgrj339z";
        const UPLOAD_PRESET = "Aj wedding";
        const firebaseConfig = {
            databaseURL: "https://framesbyarju-default-rtdb.firebaseio.com/"
        };

        // Firebase ഇനിഷ്യലൈസ് ചെയ്യുക
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database().ref("photos");

        let photos = [];
        const urlParams = new URLSearchParams(window.location.search);
        const isAdmin = urlParams.get('admin') === 'true';

        // ഡാറ്റാബേസിൽ നിന്ന് ഫോട്ടോകൾ റിയൽ-ടൈം ആയി എടുക്കുക
        db.on("value", (snapshot) => {
            const data = snapshot.val();
            photos = data ? Object.entries(data).map(([id, url]) => ({id, url})) : [];
            renderGallery();
            
            // ലോഡർ മാറ്റുക
            document.getElementById('loader').style.display = 'none';
            document.getElementById('app').classList.remove('hidden');
            if(isAdmin) document.getElementById('admin-panel').classList.remove('hidden');
        });

        // അപ്‌ലോഡ് ഫംഗ്‌ഷൻ
        document.getElementById('file-input').addEventListener('change', async function(e) {
            const files = Array.from(e.target.files);
            const status = document.getElementById('status');
            
            for (let i = 0; i < files.length; i++) {
                status.innerText = `Uploading: ${i+1}/${files.length}`;
                const formData = new FormData();
                formData.append('file', files[i]);
                formData.append('upload_preset', UPLOAD_PRESET);

                try {
                    const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();
                    if(data.secure_url) {
                        db.push(data.secure_url); // ലിങ്ക് Firebase-ലേക്ക് അയക്കുന്നു
                    }
                } catch (err) { console.error("Cloudinary Error:", err); }
            }
            status.innerText = "All Photos Uploaded!";
            setTimeout(() => status.innerText = "", 3000);
        });

        function renderGallery() {
            const gallery = document.getElementById('gallery');
            document.getElementById('photo-count').innerText = `${photos.length} Photos`;
            gallery.innerHTML = "";
            
            photos.forEach((item) => {
                const div = document.createElement('div');
                div.className = "relative aspect-square rounded-lg bg-gray-900 overflow-hidden shadow-md";
                div.innerHTML = `
                    <img src="${item.url}" class="w-full h-full object-cover cursor-pointer" onclick="window.open('${item.url}', '_blank')">
                    <div class="absolute bottom-1 right-1 flex gap-1">
                        ${isAdmin ? `<button onclick="deletePhoto('${item.id}')" class="bg-red-600/80 p-1 rounded text-[8px] text-white">X</button>` : ''}
                    </div>
                `;
                gallery.appendChild(div);
            });
        }

        function deletePhoto(id) {
            if(confirm("ഈ ഫോട്ടോ ഡിലീറ്റ് ചെയ്യണോ?")) db.child(id).remove();
        }

        function toggleQR() {
            const box = document.getElementById('qr-box');
            box.classList.toggle('hidden');
            if(!box.classList.contains('hidden')) {
                document.getElementById('qrcode').innerHTML = "";
                // അഡ്മിൻ എന്ന വാക്ക് ലിങ്കിൽ ഇല്ലാതെ QR ഉണ്ടാക്കുന്നു
                const publicUrl = window.location.origin + window.location.pathname;
                new QRCode(document.getElementById('qrcode'), {
                    text: publicUrl,
                    width: 150, height: 150
                });
            }
        }

        async function downloadAllZip() {
            if(photos.length === 0) return alert("No photos to download!");
            alert("Preparing ZIP, please wait...");
            const zip = new JSZip();
            for (let i = 0; i < photos.length; i++) {
                try {
                    const res = await fetch(photos[i].url);
                    const blob = await res.blob();
                    zip.file(`arju_photo_${i+1}.jpg`, blob);
                } catch(e) { console.error("Zip error:", e); }
            }
            const content = await zip.generateAsync({type:"blob"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(content);
            a.download = "frames_by_arju.zip";
            a.click();
        }
    </script>
</body>
</html>
